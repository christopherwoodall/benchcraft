<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Benchmark Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item:hover { background-color: #374151; }
        .sidebar-item.active { background-color: #4f46e5; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 p-4 overflow-y-auto">
            <h1 class="text-xl font-bold mb-4">Benchmarks</h1>
            <button id="new-benchmark-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg mb-4 transition duration-200">
                + New Eval
            </button>
            <nav id="benchmark-list" class="space-y-2"></nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="form-title" class="text-3xl font-bold">New Evaluation</h2>
                    <div>
                        <button id="delete-benchmark-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 hidden">Delete</button>
                        <button id="save-benchmark-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ml-2">Save</button>
                    </div>
                </div>

                <!-- Hidden field for current filename -->
                <input type="hidden" id="current-filename">

                <!-- Benchmark Metadata -->
                <div class="bg-gray-800 p-6 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Metadata</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="benchmark-name" class="block text-sm font-medium text-gray-300">Eval Name</label>
                            <input type="text" id="benchmark-name" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="benchmark-desc" class="block text-sm font-medium text-gray-300">Description</label>
                            <textarea id="benchmark-desc" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Model & Dataset -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Model Config</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="model-name" class="block text-sm font-medium text-gray-300">Model Name</label>
                                <input type="text" id="model-name" placeholder="e.g., gpt-4-turbo" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="model-temp" class="block text-sm font-medium text-gray-300">Temperature: <span id="temp-value">0.7</span></label>
                                <input type="range" id="model-temp" min="0" max="2" step="0.1" value="0.7" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Dataset & Metrics</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="dataset-name" class="block text-sm font-medium text-gray-300">Dataset</label>
                                <input type="text" id="dataset-name" placeholder="e.g., humaneval" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Metrics</label>
                                <div id="metrics-container" class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                    <label class="flex items-center"><input type="checkbox" value="accuracy" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 bg-gray-700">Accuracy</label>
                                    <label class="flex items-center"><input type="checkbox" value="bleu" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 bg-gray-700">BLEU</label>
                                    <label class="flex items-center"><input type="checkbox" value="rouge" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 bg-gray-700">ROUGE</label>
                                    <label class="flex items-center"><input type="checkbox" value="toxicity" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 bg-gray-700">Toxicity</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prompts -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 class="text-xl font-semibold">Prompts</h3>
                        <button id="add-prompt-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-200">+ Add Prompt</button>
                    </div>
                    <div id="prompts-list" class="space-y-4">
                        <!-- Prompt pairs will be injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0">
        <p id="toast-message"></p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const benchmarkList = document.getElementById('benchmark-list');
    const saveBtn = document.getElementById('save-benchmark-btn');
    const newBtn = document.getElementById('new-benchmark-btn');
    const deleteBtn = document.getElementById('delete-benchmark-btn');
    const addPromptBtn = document.getElementById('add-prompt-btn');
    const promptsList = document.getElementById('prompts-list');
    const tempSlider = document.getElementById('model-temp');
    const tempValue = document.getElementById('temp-value');

    const form = {
        name: document.getElementById('benchmark-name'),
        description: document.getElementById('benchmark-desc'),
        modelName: document.getElementById('model-name'),
        temperature: document.getElementById('model-temp'),
        dataset: document.getElementById('dataset-name'),
        metrics: document.getElementById('metrics-container'),
        currentFilename: document.getElementById('current-filename'),
        formTitle: document.getElementById('form-title')
    };

    // --- Utility Functions ---
    const showToast = (message, isError = false) => {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-100 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        setTimeout(() => {
            toast.style.opacity = '0';
        }, 3000);
    };

    // --- API Calls ---
    const api = {
        getBenchmarks: async () => {
            const response = await fetch('/api/benchmarks');
            if (!response.ok) throw new Error('Failed to fetch benchmarks.');
            return response.json();
        },
        getBenchmark: async (filename) => {
            const response = await fetch(`/api/benchmarks/${filename}`);
            if (!response.ok) throw new Error('Failed to load benchmark.');
            return response.json();
        },
        saveBenchmark: async (data) => {
            const response = await fetch('/api/benchmarks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            if (!response.ok) {
                 const error = await response.json();
                 throw new Error(error.error || 'Failed to save benchmark.');
            }
            return response.json();
        },
        deleteBenchmark: async (filename) => {
            const response = await fetch(`/api/benchmarks/${filename}`, { method: 'DELETE' });
             if (!response.ok) {
                 const error = await response.json();
                 throw new Error(error.error || 'Failed to delete benchmark.');
            }
            return response.json();
        }
    };
    
    // --- UI Rendering ---
    const renderBenchmarkList = async () => {
        try {
            const benchmarks = await api.getBenchmarks();
            benchmarkList.innerHTML = '';
            benchmarks.sort((a, b) => a.name.localeCompare(b.name));
            benchmarks.forEach(bench => {
                const item = document.createElement('a');
                item.href = '#';
                item.textContent = bench.name;
                item.dataset.filename = bench.filename;
                item.className = 'block py-2 px-3 rounded-lg sidebar-item transition duration-200';
                benchmarkList.appendChild(item);
            });
            updateActiveSidebarItem();
        } catch (error) {
            showToast(error.message, true);
        }
    };

    const createPromptElement = (system = '', user = '') => {
        const id = Date.now();
        const div = document.createElement('div');
        div.className = 'p-4 bg-gray-700 rounded-lg prompt-pair';
        div.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold text-gray-300">Prompt Pair</h4>
                <button class="remove-prompt-btn text-red-400 hover:text-red-500 font-bold text-sm">Remove</button>
            </div>
            <div class="space-y-2">
                <textarea rows="2" placeholder="System Prompt (Optional)" class="system-prompt w-full bg-gray-600 rounded-md p-2 text-sm">${system}</textarea>
                <textarea rows="3" placeholder="User Prompt" class="user-prompt w-full bg-gray-600 rounded-md p-2 text-sm">${user}</textarea>
            </div>
        `;
        promptsList.appendChild(div);
    };

    const populateForm = (data) => {
        form.name.value = data.name || '';
        form.description.value = data.description || '';
        form.modelName.value = data.model?.name || '';
        form.temperature.value = data.model?.temperature || 0.7;
        tempValue.textContent = form.temperature.value;
        form.dataset.value = data.dataset || '';
        
        // Clear and set metrics
        form.metrics.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        if (data.metrics) {
            data.metrics.forEach(metric => {
                const checkbox = form.metrics.querySelector(`input[value="${metric}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        // Clear and set prompts
        promptsList.innerHTML = '';
        if (data.prompts) {
            data.prompts.forEach(p => createPromptElement(p.system, p.user));
        }

        form.formTitle.textContent = `Editing: ${data.name}`;
        deleteBtn.classList.remove('hidden');
    };
    
    const clearForm = () => {
        form.name.value = '';
        form.description.value = '';
        form.modelName.value = '';
        form.temperature.value = 0.7;
        tempValue.textContent = '0.7';
        form.dataset.value = '';
        form.metrics.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        promptsList.innerHTML = '';
        createPromptElement(); // Add one empty prompt
        form.currentFilename.value = '';
        form.formTitle.textContent = 'New Evaluation';
        deleteBtn.classList.add('hidden');
        updateActiveSidebarItem();
    };

    const updateActiveSidebarItem = () => {
        const currentFile = form.currentFilename.value;
        document.querySelectorAll('#benchmark-list .sidebar-item').forEach(item => {
            if (item.dataset.filename === currentFile) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    };

    // --- Event Handlers ---
    const handleLoadBenchmark = async (filename) => {
        try {
            const data = await api.getBenchmark(filename);
            form.currentFilename.value = filename;
            populateForm(data);
            updateActiveSidebarItem();
        } catch (error) {
            showToast(error.message, true);
        }
    };

    const handleSaveBenchmark = async () => {
        const prompts = Array.from(document.querySelectorAll('.prompt-pair')).map(div => ({
            system: div.querySelector('.system-prompt').value,
            user: div.querySelector('.user-prompt').value
        }));
        
        const metrics = Array.from(form.metrics.querySelectorAll('input:checked')).map(cb => cb.value);

        if (!form.name.value.trim()) {
            showToast("Evaluation Name cannot be empty.", true);
            return;
        }

        const data = {
            name: form.name.value,
            description: form.description.value,
            model: {
                name: form.modelName.value,
                temperature: parseFloat(form.temperature.value)
            },
            dataset: form.dataset.value,
            metrics: metrics,
            prompts: prompts,
        };
        
        try {
            const result = await api.saveBenchmark(data);
            form.currentFilename.value = result.filename;
            showToast(result.message);
            await renderBenchmarkList();
            form.formTitle.textContent = `Editing: ${data.name}`;
            deleteBtn.classList.remove('hidden');
        } catch (error) {
            showToast(error.message, true);
        }
    };

    const handleDeleteBenchmark = async () => {
        const filename = form.currentFilename.value;
        if (!filename || !confirm(`Are you sure you want to delete this benchmark?`)) return;

        try {
            const result = await api.deleteBenchmark(filename);
            showToast(result.message);
            clearForm();
            await renderBenchmarkList();
        } catch (error) {
            showToast(error.message, true);
        }
    };
    
    // --- Event Listeners Setup ---
    benchmarkList.addEventListener('click', (e) => {
        if (e.target.matches('.sidebar-item')) {
            e.preventDefault();
            const filename = e.target.dataset.filename;
            handleLoadBenchmark(filename);
        }
    });

    promptsList.addEventListener('click', (e) => {
        if (e.target.matches('.remove-prompt-btn')) {
            e.target.closest('.prompt-pair').remove();
        }
    });

    saveBtn.addEventListener('click', handleSaveBenchmark);
    newBtn.addEventListener('click', clearForm);

    deleteBtn.addEventListener('click', handleDeleteBenchmark);
    addPromptBtn.addEventListener('click', () => createPromptElement());
    tempSlider.addEventListener('input', () => tempValue.textContent = tempSlider.value);
    
    // --- Initial Load ---
    const initialize = async () => {
        await renderBenchmarkList();
        clearForm();
    };

    initialize();
});
</script>
</body>
</html>
